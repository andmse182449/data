-- function tìm tổng số sách mà tác giả có tên tương ứng đã viết 
create function func_1(@tentacgia nvarchar(max))
returns int
as 
	begin
		declare @tong int 
		set @tong = (
		select count(s.MASACH)
		from SANGTAC s join TACGIA tg on s.MATG = tg.MATG 
		where tg.TENTG = @tentacgia
		)
		return @tong
	end
go
-- thuc thi 
declare @t int
set @t = dbo.func_1('NXB Sheth')
print N'Tổng Số sách đã sáng tác: '+ convert(char(100),@t)
go

-- function tìm số tác giả có nhiều sách nhất
create function func_2()
returns table
as 
		return 
		(
					select TACGIA.TENTG, COUNT(SANGTAC.MASACH) as N'SỐ LƯỢNG TÁC PHẨM'
					from TACGIA
					join SANGTAC on TACGIA.MATG = SANGTAC.MATG
					group by TACGIA.TENTG
					having count(SANGTAC.MASACH) >= all (select count(SANGTAC.MASACH)
													from TACGIA
													join SANGTAC on TACGIA.MATG = SANGTAC.MATG
													group by TACGIA.TENTG)
		)
go
-- thuc thi 
select * from dbo.func_2()
go


-- hinh nhu dang sai
-- tạo function tìm những cuốn sách có tổng đánh giá cao nhất
create function func_3()
returns table
as 
		return 
		(
					select SACH.TENSACH, AVG(DANHGIA) as N'ĐÁNH GIÁ'
					from SACH
					join BINHLUAN on BINHLUAN.MASACH = SACH.MASACH
					group by SACH.TENSACH
					having (SUM(DANHGIA) / COUNT(DANHGIA)) >= all (select (SUM(DANHGIA) / COUNT(DANHGIA))
													from SACH
													join BINHLUAN on BINHLUAN.MASACH = SACH.MASACH
													group by SACH.TENSACH)
		)
go
-- thuc thi 
select * from dbo.func_3()
go

-- tạo function tìm cuốn sách có lượt bình luận cao nhất
create function func_4()
returns table
as 
		return 
		(
					select SACH.MASACH ,SACH.TENSACH, count(DANHGIA) as N'SỐ LƯỢT BÌNH LUẬN'
					from SACH
					join BINHLUAN on BINHLUAN.MASACH = SACH.MASACH
					group by SACH.MASACH ,SACH.TENSACH
					having COUNT(DANHGIA) >= all (select COUNT(DANHGIA)
													from SACH
													join BINHLUAN on BINHLUAN.MASACH = SACH.MASACH
													group by SACH.MASACH ,SACH.TENSACH)
		)
go
-- thuc thi 
select * from dbo.func_4()
go

-- tìm những tác giả viết từ 2 cuốn sách trở lên
create function func_5()
returns table
as 
		return 
		(
					select TACGIA.TENTG, COUNT(SANGTAC.MASACH) as N'SỐ LƯỢNG TÁC PHẨM'
					from TACGIA
					join SANGTAC on SANGTAC.MATG = TACGIA.MATG
					group by TACGIA.TENTG
					having COUNT(SANGTAC.MASACH) >= 2
		)
go
-- thuc thi 
select * from dbo.func_4()
go

-- tìm những tác giả có tuổi lớn hơn 80
create function func_5()
returns table
as 
		return 
		(
					select TACGIA.TENTG, (year(GETDATE()) - YEAR(NGAYSINHTG)) as N'TUỔI TÁC GIẢ'
					from TACGIA
					group by TACGIA.TENTG, TACGIA.NGAYSINHTG
					having (YEAR(GETDATE()) - year(NGAYSINHTG)) >= 80
		)
go
-- thuc thi 
select * from dbo.func_5()
go

-- tìm đơn hàng có giá cao nhất
create function func_6()
returns table
as 
		return 
		(
				select c.MADH, sum(b.GIATIEN) as N'TỔNG TIỀN'
				from KHACHHANG a, SACH b, DONHANG_CHITIET c, DONHANG d
				where a.MAKH = d.MAKH 
				and b.MASACH = c.MASACH
				and c.MADH = d.MADH
				group by c.MADH
				having SUM(GIATIEN) >= all (select sum(b.GIATIEN)
											from KHACHHANG a, SACH b, DONHANG_CHITIET c, DONHANG d
											where a.MAKH = d.MAKH 
											and b.MASACH = c.MASACH
											and c.MADH = d.MADH
											group by c.MADH)
		)
go
-- thuc thi 
select * from dbo.func_6()
go
